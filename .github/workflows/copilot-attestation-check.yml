name: Copilot PR Attestation Check

on:
  pull_request:
    branches: ['main']

permissions:
  pull-requests: read
  issues: read

jobs:
  check-attestation:
    name: Check Copilot Attestation
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'Copilot'
    steps:
      - name: Check for attestation comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prCreator = context.payload.pull_request.user.login;

            console.log(`PR #${prNumber} created by: ${prCreator}`);
            console.log(`Event triggered by: ${context.payload.sender.login}`);

            // Get all assignees excluding Copilot (these should be human requestors)
            const assignees = context.payload.pull_request.assignees || [];
            const humanAssignees = assignees
              .filter(a => a.login !== prCreator)
              .map(a => a.login);

            console.log(`Human assignees (potential requestors): ${humanAssignees.join(', ')}`);

            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            console.log(`Found ${comments.data.length} comments`);

            // Check if any comment from human assignees contains attestation
            const attestationPhrases = [
              'I attest that I have verified',
              'I attest that no verification is required'
            ];

            const attestations = comments.data.filter(comment => {
              const isFromHumanAssignee = humanAssignees.includes(comment.user.login);
              const containsAttestation = attestationPhrases.some(phrase =>
                comment.body.includes(phrase)
              );

              if (isFromHumanAssignee && containsAttestation) {
                console.log(`✓ Found attestation in comment #${comment.id} from ${comment.user.login}`);
                console.log(`Comment: ${comment.body.substring(0, 100)}...`);
              }

              return isFromHumanAssignee && containsAttestation;
            });

            if (attestations.length > 0) {
              console.log(`✓ Attestation found from: ${attestations.map(a => a.user.login).join(', ')}`);
            } else {
              console.log(`✗ No attestation found from any human assignee`);
              core.setFailed(`At least one human assignee (${humanAssignees.join(', ')}) must attest with either "I attest that I have verified" or "I attest that no verification is required"`);
            }
