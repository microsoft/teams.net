name: Copilot PR Attestation Check

on:
  pull_request:
    branches: ['main']

permissions:
  pull-requests: read
  issues: read

jobs:
  check-attestation:
    name: Check Copilot Attestation
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'Copilot'
    steps:
      - name: Check for attestation comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prCreator = context.payload.pull_request.user.login;

            console.log(`PR #${prNumber} created by: ${prCreator}`);

            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            console.log(`Found ${comments.data.length} comments`);

            // Check if any comment from PR creator contains attestation
            const attestationPhrases = [
              'I attest that I have verified',
              'I attest that no verification is required'
            ];

            const hasAttestation = comments.data.some(comment => {
              const isFromCreator = comment.user.login === prCreator;
              const containsAttestation = attestationPhrases.some(phrase =>
                comment.body.includes(phrase)
              );

              if (isFromCreator && containsAttestation) {
                console.log(`✓ Found attestation in comment #${comment.id}`);
                console.log(`Comment: ${comment.body.substring(0, 100)}...`);
              }

              return isFromCreator && containsAttestation;
            });

            if (hasAttestation) {
              console.log('✓ Attestation found!');
            } else {
              console.log('✗ No attestation found from PR creator');
              core.setFailed('PR creator must attest with either "I attest that I have verified" or "I attest that no verification is required"');
            }
