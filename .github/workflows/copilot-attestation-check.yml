name: Copilot PR Attestation Check

on:
  pull_request:
    branches: ['main']

permissions:
  pull-requests: read
  issues: read

jobs:
  check-attestation:
    name: Check Copilot Attestation
    runs-on: ubuntu-latest
    if: github.event.pull_request.user.login == 'Copilot'
    steps:
      - name: Check for attestation comment
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const prCreator = context.payload.pull_request.user.login;

            console.log(`PR #${prNumber} created by: ${prCreator}`);
            console.log(`Event triggered by: ${context.payload.sender.login}`);

            // Try to get timeline events to find original requestor
            const timeline = await github.rest.issues.listEventsForTimeline({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            console.log('=== TIMELINE EVENTS ===');
            console.log(JSON.stringify(timeline.data.slice(0, 5), null, 2));
            console.log('=== END TIMELINE ===');

            // For now, use the first assignee as the original requestor
            const assignees = context.payload.pull_request.assignees || [];
            const originalRequestor = assignees.length > 0 ? assignees[0].login : null;

            console.log(`Original requestor (first assignee): ${originalRequestor}`);

            // Get all comments on the PR
            const comments = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });

            console.log(`Found ${comments.data.length} comments`);

            // Check if any comment from the original requestor contains attestation
            const attestationPhrases = [
              'I attest that I have verified',
              'I attest that no verification is required'
            ];

            const hasAttestation = comments.data.some(comment => {
              const isFromRequestor = comment.user.login === originalRequestor;
              const containsAttestation = attestationPhrases.some(phrase =>
                comment.body.includes(phrase)
              );

              if (isFromRequestor && containsAttestation) {
                console.log(`✓ Found attestation in comment #${comment.id} from ${comment.user.login}`);
                console.log(`Comment: ${comment.body.substring(0, 100)}...`);
              }

              return isFromRequestor && containsAttestation;
            });

            if (hasAttestation) {
              console.log('✓ Attestation found!');
            } else {
              console.log(`✗ No attestation found from original requestor (${originalRequestor})`);
              core.setFailed(`Original requestor (${originalRequestor}) must attest with either "I attest that I have verified" or "I attest that no verification is required"`);
            }
